<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" type="text/css" href="css.css">
		<title>Egg force one</title>
	</head>

	<body>
		<div class="menu"></div>
		<div class="info">
			<div class="info2">
				
				<div class="info3">
					<div class="infoTitre">
						<h3>Information</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3>
					</div>
					<div class="infoBody">
						
					</div>
				</div>

				<div class="info3">
					<div class="infoTitre">
						<h3>Impression</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3> 
					</div>
					<div class="infoBody">
						<table>
							<tr>
								<td class="td1">Statut</td>
								<td class="td2"><span id="statutImpression">Aucune impression</span></td>
							</tr>
							<tr>
								<td class="td1">Progression impression</td>
								<td class="td2"><progress id="progressPrint"></td>
							</tr>
							<tr>
								<td class="td1">Progression couche</td>
								<td class="td2"><progress id="progressLayer"></td>
							</tr>
							<tr>
								<td class="td1">Fichier imprimer</td>
								<td class="td2"><span id="emplacementFichier"></span></td>
							</tr>
							<tr>
								<td class="td1">Couche actuelle</td>
								<td class="td2"><span id="layerPrint"></span></td>
							</tr>
							<tr>
								<td class="td1">Nombre de lignes</td>
								<td class="td2"><span id="nbLinesPrint"></span></td>
							</tr>
							<tr>
								<td class="td1">Nombre de couches</td>
								<td class="td2"><span id="nbLayerPrint"></span></td>
							</tr>
						</table>
						<button onclick="statutPrint(3)">pause</button>
						<button onclick="statutPrint(1)">play</button>
						<button onclick="statutPrint(4)">stop</button>

					</div>
				</div>

				<div class="info3">
					<div class="infoTitre">
						<h3>Lancement impression</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3>
					</div>
					<div class="infoBody">
						<table>
							<tr class="none">
								<td class="td1">Fichier a imprimer</td>
								<td class="td2"><input type="text" id="printSrc" class="txtInput" placeholder="fichier.gcode"></td>
							</tr>
						</table>
						<div>
							<button onclick="listDirUpdate()">actualiser</button>
							<div class="listDir">
								<div class="divDirPath">
									<table id="dirPath" class="dirPath"></table>
								</div>
								<div class="listDirStart">
									<table id="listDirStart"></table>
								</div>
							</div>
						</div>

					</div>
				</div>

				<div class="info3">
					<div class="infoTitre">
						<h3>Envoyer fichier</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3>
					</div>
					<div class="infoBody">
						<form method="POST" action="/upload" enctype="multipart/form-data">
							<table>
								<tr>
									<td class="td1">Groupe</td>
									<td class="td2"><input type="text" class="txtInput" name="groupe"></td>
								</tr>
								<tr>
									<td class="td1">Fichier</td>
									<td class="td2"><input type="file" class="txtInput" name="uploadFile" id="uploadFile"></td>
								</tr>
							</table>
							<input type="submit" name="submit" value="Envoyer" class="button">
						</form>
					</div>
				</div>

				<div class="info3">
					<div class="infoTitre">
						<h3>Connection</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3>
					</div>
					<div class="infoBody">
						<table>
							<tr>
								<td class="td1">Type de connection</td>
								<td class="td2">
									<select>
										<option value="USB">USB</option>
										<option value="wifi">Wifi</option>
									</select>
								</td>
							</tr>
						</table>
					</div>
				</div>

				<div class="info3">
					<div class="infoTitre">
						<h3>USB</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3>
					</div>
					<div class="infoBody">
						<table>
							<tr>
								<td class="td1">imprimante</td>
								<td class="td2"><span id="inprimanteConnecterUsb">Non connecté</span></td>
							</tr>
						</table>
					</div>
				</div>

				<div class="info3">
					<div class="infoTitre">
						<h3>terminal</h3>
						<h3 class="openClose" onclick="openClose(this)"></h3>
					</div>
					<div class="infoBody">
						<div class="terminal">
							<div class="terminalOutput" id="outputTerm"></div>
							<div class="terminalInput">
								<input class="terminalInput2" type="text" id="inputTerm" placeholder=">">
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript" src="/jquery.min.js"></script>
		<script type="text/javascript" src="/socket.io.js"></script>
		<script type="text/javascript">
			var lenTerm 			= 1000 				// nombre de ligne garder sur le terminal
			var temp 				= "no temp data" 	// garde les derniere temperature recu
			var print 				= "0"				// statut de l'impression
			var oldPosLayer 		= 0 				// ancienne position du layer
			var PosLayer 			= 0 				// position actiel du layer
			var statutPrintData 	= 0					// donne le statu de l'impression

			var socket = io.connect('http://' + document.domain + ':' + location.port);
			//

			function openClose(test) {
				if (test.parentNode.parentNode.childNodes[3].className == "none") {
					test.parentNode.parentNode.childNodes[3].className = "infoBody";
				}
				else {
					test.parentNode.parentNode.childNodes[3].className = "none";
				}
				//test.parentNode.parentNode.childNodes[3].style.display = "none";
			}


			//
			function statutPrint(data) {
				socket.emit('statutPrint', data);
			}

			function printFolder() {
				path = document.getElementById("dirPath").lastChild.lastChild.lastChild.innerHTML + this.lastChild.innerHTML; 
				alert(path);
				$.ajax({
					type: 'POST',
					url: '/printSrc',
					data : 'path=' + path,
					success: function(data) {
						print("retour");
						// body...
					},
					error: function() {
						alert('error');
					}
				});
			}

			function listDirPos(pos="/") {
				document.getElementById('dirPath').innerHTML = "";
				var newLine = document.createElement('tr');
				newLine.className = "trPath";
				var firstElement = document.createElement('td');
				firstElement.innerHTML = "Position";
				firstElement.className = "td1";
				var secondElement = document.createElement('td');
				secondElement.className = "td2";
				var divSecondElement = document.createElement('div');
				divSecondElement.innerHTML = pos;
				divSecondElement.className = "tdDivDirPath";
				secondElement.appendChild(divSecondElement);
				newLine.appendChild(firstElement);
				newLine.appendChild(secondElement);
				document.getElementById('dirPath').appendChild(newLine);
			}

			function posDirUpdate() {
				//alert(this.innerHTML);
				tmp = document.getElementById('dirPath').lastChild.lastChild.lastChild.innerHTML + this.lastChild.innerHTML + '/';
				listDirUpdate(tmp);
				//document.getElementById('dirPath').lastChild.lastChild.lastChild.innerHTML += this.lastChild.innerHTML + '/';
			}

			function dirReturn() {
				listDirUpdate(returnPath);
			}

			function rightClickDir(tmp = "") {
				if (tmp != "") {
					alert("dossier : " + tmp.lastChild.innerHTML);
				}
			}

			function rightClickFolder(tmp = "") {
				if (tmp != "") {
					alert("fichier : " +tmp.lastChild.innerHTML);
				}
			}

			function listDirUpdate(addPath="/") {
				$.ajax({
					type: 'POST',
					url: '/dirPrint',
					data : 'path=' + addPath,
					success: function(data) {
						//alert(addPath);
						document.getElementById('listDirStart').innerHTML = "";
						listDirPos(addPath);
						if (addPath != "/") {
							var newLine = document.createElement('tr');
							var firstElement = document.createElement('td');
							firstElement.innerHTML = "Retour";
							firstElement.className = "td1";
							var secondElement = document.createElement('td');
							var temp = addPath.split("/");
							returnPath = "";
							for (var pos = 0; pos < temp.length - 2; pos++) {
								returnPath += temp[pos] + "/";
							}
							//alert("test : " + returnPath);
							secondElement.innerHTML = returnPath;
							secondElement.className = "td2";
							//newLine.onclick = listDirUpdate(returnPath);
							newLine.addEventListener("dblclick", dirReturn, false);
							newLine.appendChild(firstElement);
							newLine.appendChild(secondElement);
							document.getElementById('listDirStart').appendChild(newLine);
						}
						var temp = data.split(";");
						for (var pos = 0; pos < temp.length; pos++) {
							//listDirStart
							//alert(temp[pos] + '|||' + pos);
							var temp2 = temp[pos].split('|');
							var newLine = document.createElement('tr');
							var firstElement = document.createElement('td');
							if (temp2[1] == "True") {
								// True
								firstElement.innerHTML = "Dossier";
								// double clic
								newLine.addEventListener("dblclick", posDirUpdate, false);
								//clic Droit
								newLine.addEventListener('contextmenu',function(e) {
									alert(e);
									rightClickDir(this);
								}, false);
							}
							else {
								// False
								firstElement.innerHTML = "Fichier";
								// double clic
								newLine.addEventListener("dblclick", printFolder, false);
								//clic Droit
								newLine.addEventListener('contextmenu',function(e) {
									rightClickFolder(this);
								}, false);
							}
							firstElement.className = "td1";
							var secondElement = document.createElement('td');
							secondElement.innerHTML = temp2[0];
							secondElement.className = "td2";
							newLine.appendChild(firstElement);
							newLine.appendChild(secondElement);
							document.getElementById('listDirStart').appendChild(newLine);
						}
					},
					error: function() {
						alert('error');
					}
				});
			}

			//right click
			/*if (document.addEventListener) {
				document.addEventListener('contextmenu',function(e) {
					e.preventDefault();
				}, false);
			}*/




			listDirUpdate();

			// envoi un message pour prevenir qu'on est connecté
			socket.on('connect', function (data) {
				socket.emit('new user', "");
			});

			// reception des message pour le terminal
			socket.on('MsgTerm', function (data) {
				if (document.getElementById('outputTerm').childNodes.length >= (lenTerm * 2)) {
					document.getElementById('outputTerm').firstElementChild.remove();
					document.getElementById('outputTerm').firstElementChild.remove();
				}
				$('#outputTerm').append('<span>' + data + '</span><br>');
			});


			//reception de la temperature
			socket.on('temp', function (data) {
				temp = data
			});

			// previent si on est connecté a l'imprimante ou non
			socket.on('inprimanteConnecterUsb', function (data) {
				if (data == "True") {
					$('#inprimanteConnecterUsb').text("Connecté");
				}
				else {
					$('#inprimanteConnecterUsb').text("Non connecté");
				}
			})

			//
			socket.on('layerPrint', function(data) {
				if (data != 0) {
					$('#layerPrint').text(data);
				}
				else {
					$('#layerPrint').text("");
				}
			});

			//
			socket.on('nbLinesPrint', function(data) {
				if (data != 0) {
					$('#nbLinesPrint').text(data);
				}
				else {
					$('#nbLinesPrint').text("");
				}
			});

			//
			socket.on('nbLayerPrint', function(data) {
				if (data != 0) {
					$('#nbLayerPrint').text(data);
				}
				else {
					$('#nbLayerPrint').text("");
				}
			});

			// dit quel fichier il faut imprimé
			$("#printSrc").keypress(function(e) {
				if (e.which == 13) {
					//alert($('#printSrc').val());
					var src = $('#printSrc').val();
					$('#printSrc').val("");
					socket.emit('printSrc', src);
				}
			});
			//met a jour l'interface avec la progression
			socket.on('posPrint', function (data) {
				
				document.getElementById("progressLayer").value = data - oldPosLayer;
				document.getElementById("progressPrint").value = data;
			});
			socket.on('progressLayer', function (data) {
				allNb = data.split(" ");
				document.getElementById("progressLayer").value = allNb[2] - allNb[1];
				document.getElementById("progressLayer").max = allNb[0] - allNb[1];
				oldPosLayer = allNb[1];
			});
			socket.on('posEndPrint', function (data) {
				document.getElementById("progressPrint").max = data;
			});
			socket.on('srcImpression', function (data) {
				$('#emplacementFichier').text(data);
			})
			socket.on('statutImpression', function (data) {
				switch (data) {
					case 5:
						// initialisation de l'impression
						statutPrintData = data;
						$('#statutImpression').text("analyse en cour");
					break;
					case 0:
						// aucune impression
						statutPrintData = data;
						$('#statutImpression').text("Aucune impression");
					break;
					case 1:
						// impression en cour
						statutPrintData = data;
						$('#statutImpression').text("Impression en cour");
					break;
					case 2:
						// impression terminer
						statutPrintData = data;
						$('#statutImpression').text("Impression terminer");
					break;
					case 3:
						// impression en pause
						statutPrintData = data;
						$('#statutImpression').text("Impression en pause");
					break;
					case 4:
						// impression areter
						statutPrintData = data;
						$('#statutImpression').text("Impression arrêtée");
					break;
					default:
						$('#statutImpression').text("Bug");
				}
			});


			// analyse de la commande du terminal
			$('#inputTerm').keypress(function(e) {
				if (e.which == 13) {
					var commande = $('#inputTerm').val();
					$('#inputTerm').val("");
					var argCom = commande.split(" ");
					//alert(argCom)
					switch (argCom[0]) {
						//affiche les commande disponible
						case "help":
							$('#outputTerm').append("<span>" + "help :" + "<br>" + 
								"<dd>" + "temp : donne la temperature" + "<br>" + 
								"<dd>" + "msglvl : choisi le niveau de message afficher" + "</span><br>");
						break;
						//arret d'urgence distant du programme ATTENTION si une generation ou impression
						// est en cour ca sera coupé net 
						case "STOP":
							socket.emit('STOP', "");
							$('#outputTerm').append('<span>' + "stop execute" + '</span><br>');
						break;
						// affiche les derniere temperature recu 
						case "temp":
							$('#outputTerm').append('<span>' + temp + '</span><br>');
						break;
						// deprecié
						case "msglvl":
							if (argCom.length == 2) {
								socket.emit('msglvl', argCom[1]);
								$('#outputTerm').append("<span>" + "msglvl " + argCom[1] + " complete" + "</span><br>");
							}
							else {
								$('#outputTerm').append("<span>" + "usage> msglvl 'int:0,1,2' " + "</span><br>");
							}
						break;
						//permet d'envoyer une commande gcode
						case "gcode":
							if (argCom.length >= 2) {
								gcode = commande.substring(commande.indexOf(" "), commande.length);
								//alert(argCom[argCom.length - 1]);
								if (argCom[argCom.length - 1] != "\n") {
									gcode += "\n"
								}
								socket.emit('gcode', gcode);
							}
						break;
						// si aucune commande trouvé 
						default:
							$('#outputTerm').append('<span> commande inconnue </span><br>');
					}
				}
			});
		</script>
	</body>
</html>